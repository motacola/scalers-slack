name: CI

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]

jobs:
  test:
    name: Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install pytest-cov

      - name: Run tests with coverage
        run: |
          pytest tests/ -v --cov=src --cov-report=xml --cov-report=term-missing

      - name: Upload coverage reports
        uses: codecov/codecov-action@v5
        if: matrix.python-version == '3.12'
        with:
          file: ./coverage.xml
          flags: unittests
          fail_ci_if_error: false
        continue-on-error: true

  lint:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run ruff linter
        run: ruff check .

      - name: Run ruff formatter check
        run: ruff format --check .

      - name: Run mypy type checker
        run: mypy src

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run bandit security scan
        run: bandit -r src/ -c .bandit -f screen || echo "Security warnings detected"
        continue-on-error: true

      - name: Run pip-audit
        run: pip-audit --desc --skip-editable || echo "Dependency vulnerabilities detected"
        continue-on-error: true

  validate:
    name: Project Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Validate project structure
        run: |
          echo "Validating project structure..."
          test -d src || (echo "âŒ src/ directory missing" && exit 1)
          test -d tests || (echo "âŒ tests/ directory missing" && exit 1)
          test -d config || (echo "âŒ config/ directory missing" && exit 1)
          test -f pyproject.toml || (echo "âŒ pyproject.toml missing" && exit 1)
          test -f .env.example || (echo "âŒ .env.example missing" && exit 1)
          echo "âœ… Project structure is valid"

      - name: Check required files
        run: |
          echo "Checking required files..."
          test -f README.md || (echo "âŒ README.md missing" && exit 1)
          test -f requirements.txt || (echo "âŒ requirements.txt missing" && exit 1)
          test -f requirements-dev.txt || (echo "âŒ requirements-dev.txt missing" && exit 1)
          test -f .gitignore || (echo "âŒ .gitignore missing" && exit 1)
          test -f Makefile || (echo "âŒ Makefile missing" && exit 1)
          echo "âœ… All required files present"

      - name: Validate Python syntax
        run: |
          python -m py_compile src/*.py scripts/*.py

  summary:
    name: CI Results
    runs-on: ubuntu-latest
    needs: [test, lint, security, validate]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Linting | ${{ needs.lint.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result == 'success' && 'âœ… Passed' || 'âš ï¸ Warnings' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ needs.validate.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed logs above for more information." >> $GITHUB_STEP_SUMMARY
