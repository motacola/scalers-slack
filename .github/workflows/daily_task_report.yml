name: Daily Task Report

on:
    schedule:
        # Run at 8:00 AM UTC-4 (Barbados time) every weekday
        - cron: "0 12 * * 1-5"
    workflow_dispatch:
        inputs:
            date:
                description: "Date for report (YYYY-MM-DD, leave empty for today)"
                required: false
                default: ""
            format:
                description: "Output format"
                required: false
                default: "all"
                type: choice
                options:
                    - all
                    - csv
                    - json
                    - markdown
                    - html

jobs:
    generate-report:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Cache Playwright browsers
              uses: actions/cache@v4
              with:
                  path: ~/.cache/ms-playwright
                  key: ${{ runner.os }}-playwright-${{ hashFiles('**/requirements*.txt') }}

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
                  pip install -r requirements-browser.txt
                  playwright install chromium

            - name: Create storage state from secret
              run: |
                  echo '${{ secrets.BROWSER_STORAGE_STATE }}' > browser_storage_state.json
              env:
                  BROWSER_STORAGE_STATE: ${{ secrets.BROWSER_STORAGE_STATE }}

            - name: Generate report
              run: |
                  DATE_ARG=""
                  if [ -n "${{ github.event.inputs.date }}" ]; then
                    DATE_ARG="--date ${{ github.event.inputs.date }}"
                  fi

                  python scripts/enhanced_daily_task_report.py \
                    --format ${{ github.event.inputs.format || 'all' }} \
                    --output output/daily_task_report \
                    --group-by owner \
                    --include-mentions-search \
                    --actionable-only \
                    $DATE_ARG
              env:
                  PYTHONPATH: ${{ github.workspace }}

            - name: Upload report artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: daily-task-report-${{ github.event.inputs.date || github.run_id }}
                  path: |
                      output/daily_task_report.csv
                      output/daily_task_report.json
                      output/daily_task_report.md
                      output/daily_task_report.html
                  retention-days: 30

            - name: Commit reports to repository
              run: |
                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action"

                  DATE_SUFFIX=$(date +%Y-%m-%d)
                  if [ -n "${{ github.event.inputs.date }}" ]; then
                    DATE_SUFFIX=${{ github.event.inputs.date }}
                  fi

                  # Copy reports with date suffix
                  cp output/daily_task_report.csv "output/daily_task_report_${DATE_SUFFIX}.csv"
                  cp output/daily_task_report.md "output/daily_task_report_${DATE_SUFFIX}.md"
                  cp output/daily_task_report.html "output/daily_task_report_${DATE_SUFFIX}.html"

                  git add output/
                  git diff --staged --quiet || git commit -m "Add daily task report for ${DATE_SUFFIX}"
                  git push

            - name: Post summary to GitHub Actions
              run: |
                  echo "## Daily Task Report Generated" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Date:** ${{ github.event.inputs.date || 'today' }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Downloads" >> $GITHUB_STEP_SUMMARY
                  echo "- [CSV Report](daily_task_report.csv)" >> $GITHUB_STEP_SUMMARY
                  echo "- [JSON Report](daily_task_report.json)" >> $GITHUB_STEP_SUMMARY
                  echo "- [Markdown Report](daily_task_report.md)" >> $GITHUB_STEP_SUMMARY
                  echo "- [HTML Report](daily_task_report.html)" >> $GITHUB_STEP_SUMMARY
